"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[896],{233:(e,t,r)=>{r.d(t,{UC:()=>s,lJ:()=>a});let s={ACCEPT:.6,STRONG:.8,LOW:.4};function a(e){var t,r;return{letter:e.letter||"",confidence:null!==(t=e.confidence)&&void 0!==t?t:0,processingTimeMs:null!==(r=e.processing_time_ms)&&void 0!==r?r:0,hasLandmarks:!!e.landmarks_detected,raw:e}}},896:(e,t,r)=>{r.d(t,{T:()=>o});var s=r(2115),a=r(3392),n=r(233);function o(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t={debug:!1,autoConnect:!1,confidenceThreshold:n.UC.ACCEPT,frameInterval:200,cameraConstraints:{width:640,height:480,facingMode:"user"},...e},[r,o]=(0,s.useState)(!1),[i,c]=(0,s.useState)("prompt"),[l,u]=(0,s.useState)(!1),[d,h]=(0,s.useState)(""),[m,p]=(0,s.useState)(!1),[g,f]=(0,s.useState)(""),[v,b]=(0,s.useState)(0),[w,R]=(0,s.useState)(null),C=(0,s.useRef)(null),T=(0,s.useRef)(null),S=(0,s.useRef)(null),E=(0,s.useRef)(null),[I,k]=(0,s.useState)({totalFramesSent:0,successfulPredictions:0,averageConfidence:0,sessionDuration:0,droppedFrames:0}),F=(0,s.useRef)(Date.now()),{status:M,lastPrediction:y,error:A,connect:_,disconnect:D,sendFrame:W}=(0,a.U)({autoConnect:t.autoConnect,log:t.debug}),H=(0,s.useCallback)(function(e){for(var r=arguments.length,s=Array(r>1?r-1:0),a=1;a<r;a++)s[a-1]=arguments[a];t.debug&&console.log("[ADV_CAM_".concat(e,"]"),...s)},[t.debug]);(0,s.useEffect)(()=>{A&&h(A)},[A]),(0,s.useEffect)(()=>{if(!y)return;H("PREDICTION",y);let e=y.letter||"",r=y.confidence||0;k(e=>({...e,totalFramesSent:e.totalFramesSent+1,successfulPredictions:r>=t.confidenceThreshold?e.successfulPredictions+1:e.successfulPredictions,averageConfidence:(e.averageConfidence*e.totalFramesSent+r)/(e.totalFramesSent+1),sessionDuration:Date.now()-F.current})),r>=t.confidenceThreshold&&e?f(e):e||f("?"),b(r),R({success:!0,method:"websocket_prediction",result:{text:e||"?",confidence:r,processing_time_ms:y.processingTimeMs||0,signs_detected:+!!y.hasLandmarks,detailed_predictions:[]}})},[y,t.confidenceThreshold,H]),(0,s.useEffect)(()=>{o("undefined"!=typeof navigator&&"mediaDevices"in navigator&&"getUserMedia"in navigator.mediaDevices)},[]);let N=(0,s.useCallback)(async()=>{if(!r)return h("Camera not supported in this browser"),!1;u(!0),h("");try{H("INIT","Solicitando permisos de c\xe1mara...");let e={video:{width:{ideal:t.cameraConstraints.width},height:{ideal:t.cameraConstraints.height},facingMode:t.cameraConstraints.facingMode},audio:!1},r=await navigator.mediaDevices.getUserMedia(e);return T.current=r,C.current&&(C.current.srcObject=r,C.current.autoplay=!0,C.current.playsInline=!0,C.current.muted=!0,await new Promise((e,t)=>{let r=C.current,s=()=>{r.removeEventListener("loadedmetadata",s),r.removeEventListener("error",a),e()},a=e=>{r.removeEventListener("loadedmetadata",s),r.removeEventListener("error",a),t(Error("Video load error"))};r.addEventListener("loadedmetadata",s),r.addEventListener("error",a),r.readyState>=1&&s()}),await C.current.play()),c("granted"),H("INIT","C\xe1mara inicializada correctamente"),!0}catch(t){c("denied");let e="NotAllowedError"===t.name?"Camera permission denied":"Camera initialization failed: ".concat(t.message);return h(e),H("INIT_ERROR",e,t),!1}finally{u(!1)}},[r,t.cameraConstraints,H]),O=(0,s.useCallback)(function(e){let r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!(r||m)){H("FRAME","No traduciendo, saltando frame");return}if(!(null==e?void 0:e.current)){if(H("FRAME","Sin cameraViewRef, usando videoRef directo"),!C.current||C.current.readyState<2){k(e=>({...e,droppedFrames:e.droppedFrames+1}));return}try{S.current||(S.current=document.createElement("canvas"));let e=S.current,r=C.current;e.width=r.videoWidth||t.cameraConstraints.width||640,e.height=r.videoHeight||t.cameraConstraints.height||480;let s=e.getContext("2d");if(!s)return;s.drawImage(r,0,0,e.width,e.height);let a=e.toDataURL("image/jpeg",.8).split(",")[1];a&&(W(a),H("FRAME","Frame enviado desde videoRef (".concat(a.length," chars)")))}catch(e){H("FRAME_ERROR","Error capturando desde videoRef:",e),k(e=>({...e,droppedFrames:e.droppedFrames+1}))}return}try{var s,a;let r=(null===(s=(a=e.current).getVideoElement)||void 0===s?void 0:s.call(a))||C.current;if(!r||r.readyState<2){k(e=>({...e,droppedFrames:e.droppedFrames+1}));return}S.current||(S.current=document.createElement("canvas"));let n=S.current;n.width=r.videoWidth||t.cameraConstraints.width||640,n.height=r.videoHeight||t.cameraConstraints.height||480;let o=n.getContext("2d");if(!o)return;o.drawImage(r,0,0,n.width,n.height);let i=n.toDataURL("image/jpeg",.8).split(",")[1];i&&(W(i),H("FRAME","Frame enviado desde cameraViewRef (".concat(i.length," chars)")))}catch(e){H("FRAME_ERROR","Error capturando frame:",e),k(e=>({...e,droppedFrames:e.droppedFrames+1}))}},[m,W,t.cameraConstraints,H]),P=(0,s.useCallback)(e=>{m||(H("RT_START","Iniciando traducci\xf3n en tiempo real"),F.current=Date.now(),_(),p(!0),f(""),b(0),E.current=setInterval(()=>{O(e,!0)},t.frameInterval),H("RT_START","Interval iniciado con ID: ".concat(E.current)))},[m,_,O,t.frameInterval,H]),L=(0,s.useCallback)(()=>{m&&(H("RT_STOP","Deteniendo traducci\xf3n"),p(!1),E.current&&(clearInterval(E.current),E.current=null),D())},[m,D,H]),x=(0,s.useCallback)(()=>{H("CLEANUP","Limpiando recursos"),T.current&&(T.current.getTracks().forEach(e=>e.stop()),T.current=null),C.current&&(C.current.srcObject=null),L(),c("prompt"),h(""),k({totalFramesSent:0,successfulPredictions:0,averageConfidence:0,sessionDuration:0,droppedFrames:0})},[L,H]),U=(0,s.useCallback)(()=>new Promise(e=>{if(!C.current||C.current.readyState<2){e(null);return}let t=document.createElement("canvas"),r=t.getContext("2d");if(!r){e(null);return}let s=C.current;t.width=s.videoWidth,t.height=s.videoHeight,r.drawImage(s,0,0),t.toBlob(t=>{t?e(new File([t],"frame.jpg",{type:"image/jpeg"})):e(null)},"image/jpeg",.8)}),[]),j=(0,s.useCallback)(()=>({...I,sessionDuration:Date.now()-F.current}),[I]),J=(0,s.useCallback)(e=>{Object.assign(t,e),H("CONFIG","Opciones actualizadas:",e)},[t,H]);return(0,s.useEffect)(()=>()=>{E.current&&clearInterval(E.current)},[]),{videoRef:C,isSupported:r,permission:i,isInitializing:l,error:d,isTranslating:m,currentPrediction:g,confidence:v,lastTranslation:w,realtimeStatus:M,initialize:N,cleanup:x,captureFrame:U,startRealtimeTranslation:P,stopRealtimeTranslation:L,getStats:j,updateOptions:J}}},3392:(e,t,r)=>{r.d(t,{U:()=>i});var s=r(2115),a=r(233);let n={autoReconnect:!0,maxReconnectAttempts:10,backoffInitialMs:500,backoffFactor:2,backoffMaxMs:5e3,heartbeatIntervalMs:2e4,heartbeatTimeoutMs:5e3,log:!1};class o{getStatus(){return this.status}getSessionId(){return this.sessionId}on(e,t){let r=this.listeners[e]||[];return r.push(t),this.listeners[e]=r,()=>{let r=this.listeners[e]||[];this.listeners[e]=r.filter(e=>e!==t)}}emit(e){for(var t,r=arguments.length,s=Array(r>1?r-1:0),a=1;a<r;a++)s[a-1]=arguments[a];null===(t=this.listeners[e])||void 0===t||t.forEach(e=>{try{e(...s)}catch(e){this.opts.log&&console.error("[Realtime] listener error",e)}})}connect(){if(this.ws&&("open"===this.status||"connecting"===this.status)){this.opts.log&&console.log("[RealtimeWS] Ya conectado/conectando, estado:",this.status);return}this.status=this.reconnectAttempts>0?"reconnecting":"connecting",this.opts.log&&console.log("[RealtimeWS] Intentando conectar a:",this.url);try{this.ws=new WebSocket(this.url)}catch(e){this.opts.log&&console.error("[RealtimeWS] Error creando WebSocket:",e),this.status="error",this.emit("error",e);return}this.ws.onopen=()=>{this.opts.log&&console.log("[RealtimeWS] Conexi\xf3n abierta"),this.status="open",this.emit("open"),this.reconnectAttempts=0,this.startHeartbeat()},this.ws.onmessage=e=>{let t;this.opts.log&&console.log("[RealtimeWS] Mensaje recibido:",e.data);try{t=JSON.parse(e.data)}catch(e){return}switch(this.emit("raw",t),t.type){case"session":this.sessionId=t.session_id,this.emit("session",this.sessionId);break;case"prediction":{let e=(0,a.lJ)(t);this.emit("prediction",e);break}case"pong":this.clearHeartbeatTimeout();break;case"error":this.emit("error",t.error)}},this.ws.onerror=e=>{this.opts.log&&console.error("[RealtimeWS] Error en WebSocket:",e),this.emit("error",e)},this.ws.onclose=e=>{this.opts.log&&console.log("[RealtimeWS] Conexi\xf3n cerrada:",e.code,e.reason),this.stopHeartbeat(),this.emit("close",e),"closing"!==this.status&&(this.status="error",this.opts.autoReconnect&&this.reconnectAttempts<this.opts.maxReconnectAttempts&&this.scheduleReconnect())}}scheduleReconnect(){this.reconnectAttempts+=1;let e=Math.min(this.opts.backoffInitialMs*Math.pow(this.opts.backoffFactor,this.reconnectAttempts-1),this.opts.backoffMaxMs);this.emit("reconnect",this.reconnectAttempts,e),setTimeout(()=>this.connect(),e)}startHeartbeat(){this.opts.heartbeatIntervalMs<=0||(this.stopHeartbeat(),this.heartbeatTimer=setInterval(()=>{this.ws&&"open"===this.status&&(this.sendPing(),this.setHeartbeatTimeout())},this.opts.heartbeatIntervalMs))}stopHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=null,this.clearHeartbeatTimeout()}setHeartbeatTimeout(){this.clearHeartbeatTimeout(),this.heartbeatTimeout=setTimeout(()=>{this.opts.log&&console.warn("[Realtime] Heartbeat timeout - forcing reconnect"),this.forceReconnect()},this.opts.heartbeatTimeoutMs)}clearHeartbeatTimeout(){this.heartbeatTimeout&&clearTimeout(this.heartbeatTimeout),this.heartbeatTimeout=null}forceReconnect(){if(this.ws)try{this.ws.close()}catch(e){}}sendFrame(e){if(!this.ws||"open"!==this.status){this.opts.log&&console.warn("[RealtimeWS] No se puede enviar frame, ws:",!!this.ws,"status:",this.status);return}let t={type:"frame",image:e,timestamp:Date.now()};this.opts.log&&console.log("[RealtimeWS] Enviando frame, tama\xf1o:",e.length,"chars"),this.ws.send(JSON.stringify(t))}sendPing(){if(!this.ws||"open"!==this.status)return;let e={type:"ping",timestamp:Date.now()};this.ws.send(JSON.stringify(e))}close(){if(this.status="closing",this.stopHeartbeat(),this.ws)try{this.ws.close()}catch(e){}this.ws=null,this.status="idle"}constructor(e={}){this.ws=null,this.status="idle",this.listeners={},this.reconnectAttempts=0,this.heartbeatTimer=null,this.heartbeatTimeout=null,this.sessionId=null;let t="http://localhost:8000",r=e.url||(t.startsWith("https")?t.replace("https","wss"):t.replace("http","ws"));this.url=r.replace(/\/$/,"")+"/api/v1/ml/predict",this.opts={...n,...e},this.opts.log&&console.log("[RealtimeWS] URL construida:",this.url)}}function i(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=(0,s.useRef)(null),[r,a]=(0,s.useState)("idle"),[n,i]=(0,s.useState)(null),[c,l]=(0,s.useState)(null),[u,d]=(0,s.useState)(null),[h,m]=(0,s.useState)(null),p=(0,s.useCallback)(t=>{e.log&&console.log("[RT] prediction",t),i(e=>!e||e.letter!==t.letter||Math.abs((e.confidence||0)-(t.confidence||0))>.01?t:e)},[e.log]);t.current||(t.current=new o({log:e.log}));let g=(0,s.useCallback)(()=>{var e;null===(e=t.current)||void 0===e||e.connect()},[]),f=(0,s.useCallback)(()=>{var e;null===(e=t.current)||void 0===e||e.close(),a("idle")},[]),v=(0,s.useCallback)(e=>{var r;null===(r=t.current)||void 0===r||r.sendFrame(e)},[]);return(0,s.useEffect)(()=>{let r=t.current,s=r.on("open",()=>{e.log&&console.log("[RT] open"),a("open"),d(null)}),n=r.on("close",()=>{e.log&&console.log("[RT] close"),a("idle")}),o=r.on("error",t=>{e.log&&console.error("[RT] error",t),d("string"==typeof t?t:"Realtime error"),a("error")}),i=r.on("session",t=>{e.log&&console.log("[RT] session",t),l(t)}),c=r.on("prediction",p),u=r.on("reconnect",(t,r)=>{e.log&&console.warn("[RT] reconnect",{attempt:t,delayMs:r}),a("reconnecting"),m({attempt:t,delayMs:r})}),h=r.on("raw",t=>{e.log&&console.debug("[RT] raw",t)});return e.autoConnect&&g(),()=>{s(),n(),o(),i(),c(),u(),h()}},[e.autoConnect,p,e.log]),{status:r,lastPrediction:n,sessionId:c,error:u,reconnectInfo:h,connect:g,disconnect:f,sendFrame:v}}}}]);