"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[896],{233:(e,t,s)=>{s.d(t,{UC:()=>r,lJ:()=>n});let r={ACCEPT:.6,STRONG:.8,LOW:.4};function n(e){var t,s;return{letter:e.letter||"",confidence:null!==(t=e.confidence)&&void 0!==t?t:0,processingTimeMs:null!==(s=e.processing_time_ms)&&void 0!==s?s:0,hasLandmarks:!!e.landmarks_detected,raw:e}}},896:(e,t,s)=>{s.d(t,{T:()=>a});var r=s(2115),n=s(3392),i=s(233);function a(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=(0,r.useMemo)(()=>({debug:!1,autoConnect:!1,confidenceThreshold:i.UC.ACCEPT,frameInterval:200,cameraConstraints:{width:640,height:480,facingMode:"user"},...e}),[e]),[s,a]=(0,r.useState)(!1),[o,c]=(0,r.useState)("prompt"),[l,u]=(0,r.useState)(!1),[h,d]=(0,r.useState)(""),[m,p]=(0,r.useState)(!1),[g,f]=(0,r.useState)(""),[v,w]=(0,r.useState)(0),[b,R]=(0,r.useState)(null),C=(0,r.useRef)(null),T=(0,r.useRef)(null),S=(0,r.useRef)(null),E=(0,r.useRef)(null),[I,k]=(0,r.useState)({totalFramesSent:0,successfulPredictions:0,averageConfidence:0,sessionDuration:0,droppedFrames:0}),F=(0,r.useRef)(Date.now()),{status:M,lastPrediction:y,error:A,connect:_,disconnect:D,sendFrame:W}=(0,n.U)({autoConnect:t.autoConnect,log:t.debug}),H=(0,r.useCallback)(function(e){for(var s=arguments.length,r=Array(s>1?s-1:0),n=1;n<s;n++)r[n-1]=arguments[n];t.debug&&console.log("[ADV_CAM_".concat(e,"]"),...r)},[t.debug]);(0,r.useEffect)(()=>{A&&d(A)},[A]),(0,r.useEffect)(()=>{if(!y)return;H("PREDICTION",y);let e=y.letter||"",s=y.confidence||0;k(e=>({...e,totalFramesSent:e.totalFramesSent+1,successfulPredictions:s>=t.confidenceThreshold?e.successfulPredictions+1:e.successfulPredictions,averageConfidence:(e.averageConfidence*e.totalFramesSent+s)/(e.totalFramesSent+1),sessionDuration:Date.now()-F.current})),s>=t.confidenceThreshold&&e?f(e):e||f("?"),w(s),R({success:!0,method:"websocket_prediction",result:{text:e||"?",confidence:s,processing_time_ms:y.processingTimeMs||0,signs_detected:+!!y.hasLandmarks,detailed_predictions:[]}})},[y,t.confidenceThreshold,H]),(0,r.useEffect)(()=>{a("undefined"!=typeof navigator&&"mediaDevices"in navigator&&"getUserMedia"in navigator.mediaDevices)},[]);let N=(0,r.useCallback)(async()=>{if(!s)return d("Camera not supported in this browser"),!1;u(!0),d("");try{H("INIT","Solicitando permisos de c\xe1mara...");let e={video:{width:{ideal:t.cameraConstraints.width},height:{ideal:t.cameraConstraints.height},facingMode:t.cameraConstraints.facingMode},audio:!1},s=await navigator.mediaDevices.getUserMedia(e);return T.current=s,C.current&&(C.current.srcObject=s,C.current.autoplay=!0,C.current.playsInline=!0,C.current.muted=!0,await new Promise((e,t)=>{let s=C.current,r=()=>{s.removeEventListener("loadedmetadata",r),s.removeEventListener("error",n),e()},n=()=>{s.removeEventListener("loadedmetadata",r),s.removeEventListener("error",n),t(Error("Video load error"))};s.addEventListener("loadedmetadata",r),s.addEventListener("error",n),s.readyState>=1&&r()}),await C.current.play()),c("granted"),H("INIT","C\xe1mara inicializada correctamente"),!0}catch(t){c("denied");let e="Camera initialization failed";return t instanceof Error?H("INIT_ERROR",e="NotAllowedError"===t.name?"Camera permission denied":"Camera initialization failed: ".concat(t.message),t):H("INIT_ERROR",e),d(e),!1}finally{u(!1)}},[s,t.cameraConstraints,H]),O=(0,r.useCallback)(function(e){let s=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!(s||m)){H("FRAME","No traduciendo, saltando frame");return}if(!(null==e?void 0:e.current)){if(H("FRAME","Sin cameraViewRef, usando videoRef directo"),!C.current||C.current.readyState<2){k(e=>({...e,droppedFrames:e.droppedFrames+1}));return}try{S.current||(S.current=document.createElement("canvas"));let e=S.current,s=C.current;e.width=s.videoWidth||t.cameraConstraints.width||640,e.height=s.videoHeight||t.cameraConstraints.height||480;let r=e.getContext("2d");if(!r)return;r.drawImage(s,0,0,e.width,e.height);let n=e.toDataURL("image/jpeg",.8).split(",")[1];n&&(W(n),H("FRAME","Frame enviado desde videoRef (".concat(n.length," chars)")))}catch(e){H("FRAME_ERROR","Error capturando desde videoRef"),k(e=>({...e,droppedFrames:e.droppedFrames+1}))}return}try{var r,n;let s=(null===(n=e.current)||void 0===n?void 0:null===(r=n.getVideoElement)||void 0===r?void 0:r.call(n))||C.current;if(!s||s.readyState<2){k(e=>({...e,droppedFrames:e.droppedFrames+1}));return}S.current||(S.current=document.createElement("canvas"));let i=S.current;i.width=s.videoWidth||t.cameraConstraints.width||640,i.height=s.videoHeight||t.cameraConstraints.height||480;let a=i.getContext("2d");if(!a)return;a.drawImage(s,0,0,i.width,i.height);let o=i.toDataURL("image/jpeg",.8).split(",")[1];o&&(W(o),H("FRAME","Frame enviado desde cameraViewRef (".concat(o.length," chars)")))}catch(e){H("FRAME_ERROR","Error capturando frame"),k(e=>({...e,droppedFrames:e.droppedFrames+1}))}},[m,W,t.cameraConstraints,H]),P=(0,r.useCallback)(e=>{m||(H("RT_START","Iniciando traducci\xf3n en tiempo real"),F.current=Date.now(),_(),p(!0),f(""),w(0),E.current=setInterval(()=>{O(e,!0)},t.frameInterval),H("RT_START","Interval iniciado con ID: ".concat(E.current)))},[m,_,O,t.frameInterval,H]),L=(0,r.useCallback)(()=>{m&&(H("RT_STOP","Deteniendo traducci\xf3n"),p(!1),E.current&&(clearInterval(E.current),E.current=null),D())},[m,D,H]),x=(0,r.useCallback)(()=>{H("CLEANUP","Limpiando recursos"),T.current&&(T.current.getTracks().forEach(e=>e.stop()),T.current=null),C.current&&(C.current.srcObject=null),L(),c("prompt"),d(""),k({totalFramesSent:0,successfulPredictions:0,averageConfidence:0,sessionDuration:0,droppedFrames:0})},[L,H]),U=(0,r.useCallback)(()=>new Promise(e=>{if(!C.current||C.current.readyState<2){e(null);return}let t=document.createElement("canvas"),s=t.getContext("2d");if(!s){e(null);return}let r=C.current;t.width=r.videoWidth,t.height=r.videoHeight,s.drawImage(r,0,0),t.toBlob(t=>{t?e(new File([t],"frame.jpg",{type:"image/jpeg"})):e(null)},"image/jpeg",.8)}),[]),j=(0,r.useCallback)(()=>({...I,sessionDuration:Date.now()-F.current}),[I]),J=(0,r.useCallback)(e=>{Object.assign(t,e),H("CONFIG","Opciones actualizadas:",e)},[H,t]);return(0,r.useEffect)(()=>()=>{E.current&&clearInterval(E.current)},[]),{videoRef:C,isSupported:s,permission:o,isInitializing:l,error:h,isTranslating:m,currentPrediction:g,confidence:v,lastTranslation:b,realtimeStatus:M,initialize:N,cleanup:x,captureFrame:U,startRealtimeTranslation:P,stopRealtimeTranslation:L,getStats:j,updateOptions:J}}},3392:(e,t,s)=>{s.d(t,{U:()=>o});var r=s(2115),n=s(233);let i={autoReconnect:!0,maxReconnectAttempts:10,backoffInitialMs:500,backoffFactor:2,backoffMaxMs:5e3,heartbeatIntervalMs:2e4,heartbeatTimeoutMs:5e3,log:!1};class a{getStatus(){return this.status}getSessionId(){return this.sessionId}on(e,t){switch(e){case"open":return this.listeners.open.push(t),()=>{this.listeners.open=this.listeners.open.filter(e=>e!==t)};case"close":return this.listeners.close.push(t),()=>{this.listeners.close=this.listeners.close.filter(e=>e!==t)};case"error":return this.listeners.error.push(t),()=>{this.listeners.error=this.listeners.error.filter(e=>e!==t)};case"session":return this.listeners.session.push(t),()=>{this.listeners.session=this.listeners.session.filter(e=>e!==t)};case"prediction":return this.listeners.prediction.push(t),()=>{this.listeners.prediction=this.listeners.prediction.filter(e=>e!==t)};case"raw":return this.listeners.raw.push(t),()=>{this.listeners.raw=this.listeners.raw.filter(e=>e!==t)};case"reconnect":return this.listeners.reconnect.push(t),()=>{this.listeners.reconnect=this.listeners.reconnect.filter(e=>e!==t)};default:throw Error("Evento no soportado: ".concat(e))}}emit(e){for(var t,s=arguments.length,r=Array(s>1?s-1:0),n=1;n<s;n++)r[n-1]=arguments[n];null===(t=this.listeners[e])||void 0===t||t.forEach(e=>{try{e(...r)}catch(e){this.opts.log&&console.error("[Realtime] listener error",e)}})}connect(){if(this.ws&&("open"===this.status||"connecting"===this.status)){this.opts.log&&console.log("[RealtimeWS] Ya conectado/conectando, estado:",this.status);return}this.status=this.reconnectAttempts>0?"reconnecting":"connecting",this.opts.log&&console.log("[RealtimeWS] Intentando conectar a:",this.url);try{this.ws=new WebSocket(this.url)}catch(e){this.opts.log&&console.error("[RealtimeWS] Error creando WebSocket:",e),this.status="error",this.emit("error",e);return}this.ws.onopen=()=>{this.opts.log&&console.log("[RealtimeWS] Conexi\xf3n abierta"),this.status="open",this.emit("open"),this.reconnectAttempts=0,this.startHeartbeat()},this.ws.onmessage=e=>{let t;this.opts.log&&console.log("[RealtimeWS] Mensaje recibido:",e.data);try{t=JSON.parse(e.data)}catch(e){return}switch(this.emit("raw",t),t.type){case"session":this.sessionId=t.session_id,this.emit("session",this.sessionId);break;case"prediction":{let e=(0,n.lJ)(t);this.emit("prediction",e);break}case"pong":this.clearHeartbeatTimeout();break;case"error":this.emit("error",t.error)}},this.ws.onerror=e=>{this.opts.log&&console.error("[RealtimeWS] Error en WebSocket:",e),this.emit("error",e)},this.ws.onclose=e=>{this.opts.log&&console.log("[RealtimeWS] Conexi\xf3n cerrada:",e.code,e.reason),this.stopHeartbeat(),this.emit("close",e),"closing"!==this.status&&(this.status="error",this.opts.autoReconnect&&this.reconnectAttempts<this.opts.maxReconnectAttempts&&this.scheduleReconnect())}}scheduleReconnect(){this.reconnectAttempts+=1;let e=Math.min(this.opts.backoffInitialMs*Math.pow(this.opts.backoffFactor,this.reconnectAttempts-1),this.opts.backoffMaxMs);this.emit("reconnect",this.reconnectAttempts,e),setTimeout(()=>this.connect(),e)}startHeartbeat(){this.opts.heartbeatIntervalMs<=0||(this.stopHeartbeat(),this.heartbeatTimer=setInterval(()=>{this.ws&&"open"===this.status&&(this.sendPing(),this.setHeartbeatTimeout())},this.opts.heartbeatIntervalMs))}stopHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=null,this.clearHeartbeatTimeout()}setHeartbeatTimeout(){this.clearHeartbeatTimeout(),this.heartbeatTimeout=setTimeout(()=>{this.opts.log&&console.warn("[Realtime] Heartbeat timeout - forcing reconnect"),this.forceReconnect()},this.opts.heartbeatTimeoutMs)}clearHeartbeatTimeout(){this.heartbeatTimeout&&clearTimeout(this.heartbeatTimeout),this.heartbeatTimeout=null}forceReconnect(){if(this.ws)try{this.ws.close()}catch(e){}}sendFrame(e){if(!this.ws||"open"!==this.status){this.opts.log&&console.warn("[RealtimeWS] No se puede enviar frame, ws:",!!this.ws,"status:",this.status);return}let t={type:"frame",image:e,timestamp:Date.now()};this.opts.log&&console.log("[RealtimeWS] Enviando frame, tama\xf1o:",e.length,"chars"),this.ws.send(JSON.stringify(t))}sendPing(){if(!this.ws||"open"!==this.status)return;let e={type:"ping",timestamp:Date.now()};this.ws.send(JSON.stringify(e))}close(){if(this.status="closing",this.stopHeartbeat(),this.ws)try{this.ws.close()}catch(e){}this.ws=null,this.status="idle"}constructor(e={}){this.ws=null,this.status="idle",this.listeners={open:[],close:[],error:[],session:[],prediction:[],raw:[],reconnect:[]},this.reconnectAttempts=0,this.heartbeatTimer=null,this.heartbeatTimeout=null,this.sessionId=null;let t="http://localhost:8000",s=e.url||(t.startsWith("https")?t.replace("https","wss"):t.replace("http","ws"));this.url=s.replace(/\/$/,"")+"/api/v1/ml/predict",this.opts={...i,...e},this.opts.log&&console.log("[RealtimeWS] URL construida:",this.url)}}function o(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=(0,r.useRef)(null),[s,n]=(0,r.useState)("idle"),[i,o]=(0,r.useState)(null),[c,l]=(0,r.useState)(null),[u,h]=(0,r.useState)(null),[d,m]=(0,r.useState)(null),p=(0,r.useCallback)(t=>{e.log&&console.log("[RT] prediction",t),o(e=>!e||e.letter!==t.letter||Math.abs((e.confidence||0)-(t.confidence||0))>.01?t:e)},[e.log]);t.current||(t.current=new a({log:e.log}));let g=(0,r.useCallback)(()=>{var e;null===(e=t.current)||void 0===e||e.connect()},[]),f=(0,r.useCallback)(()=>{var e;null===(e=t.current)||void 0===e||e.close(),n("idle")},[]),v=(0,r.useCallback)(e=>{var s;null===(s=t.current)||void 0===s||s.sendFrame(e)},[]);return(0,r.useEffect)(()=>{let s=t.current,r=s.on("open",()=>{e.log&&console.log("[RT] open"),n("open"),h(null)}),i=s.on("close",()=>{e.log&&console.log("[RT] close"),n("idle")}),a=s.on("error",t=>{e.log&&console.error("[RT] error",t),h("string"==typeof t?t:"Realtime error"),n("error")}),o=s.on("session",t=>{e.log&&console.log("[RT] session",t),l(t)}),c=s.on("prediction",p),u=s.on("reconnect",(t,s)=>{e.log&&console.warn("[RT] reconnect",{attempt:t,delayMs:s}),n("reconnecting"),m({attempt:t,delayMs:s})}),d=s.on("raw",t=>{e.log&&console.debug("[RT] raw",t)});return e.autoConnect&&g(),()=>{r(),i(),a(),o(),c(),u(),d()}},[e.autoConnect,p,e.log]),{status:s,lastPrediction:i,sessionId:c,error:u,reconnectInfo:d,connect:g,disconnect:f,sendFrame:v}}}}]);