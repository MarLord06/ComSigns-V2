"use strict";exports.id=564,exports.ids=[564],exports.modules={1313:(e,t,s)=>{s.d(t,{UC:()=>r,lJ:()=>a});let r={ACCEPT:.6,STRONG:.8,LOW:.4};function a(e){return{letter:e.letter||"",confidence:e.confidence??0,processingTimeMs:e.processing_time_ms??0,hasLandmarks:!!e.landmarks_detected,raw:e}}},1752:(e,t,s)=>{s.d(t,{U:()=>o});var r=s(3210),a=s(1313);let i={autoReconnect:!0,maxReconnectAttempts:10,backoffInitialMs:500,backoffFactor:2,backoffMaxMs:5e3,heartbeatIntervalMs:2e4,heartbeatTimeoutMs:5e3,log:!1};class n{constructor(e={}){this.ws=null,this.status="idle",this.listeners={open:[],close:[],error:[],session:[],prediction:[],raw:[],reconnect:[]},this.reconnectAttempts=0,this.heartbeatTimer=null,this.heartbeatTimeout=null,this.sessionId=null;let t="http://localhost:8000",s=e.url||(t.startsWith("https")?t.replace("https","wss"):t.replace("http","ws"));this.url=s.replace(/\/$/,"")+"/api/v1/ml/predict",this.opts={...i,...e},this.opts.log&&console.log("[RealtimeWS] URL construida:",this.url)}getStatus(){return this.status}getSessionId(){return this.sessionId}on(e,t){switch(e){case"open":return this.listeners.open.push(t),()=>{this.listeners.open=this.listeners.open.filter(e=>e!==t)};case"close":return this.listeners.close.push(t),()=>{this.listeners.close=this.listeners.close.filter(e=>e!==t)};case"error":return this.listeners.error.push(t),()=>{this.listeners.error=this.listeners.error.filter(e=>e!==t)};case"session":return this.listeners.session.push(t),()=>{this.listeners.session=this.listeners.session.filter(e=>e!==t)};case"prediction":return this.listeners.prediction.push(t),()=>{this.listeners.prediction=this.listeners.prediction.filter(e=>e!==t)};case"raw":return this.listeners.raw.push(t),()=>{this.listeners.raw=this.listeners.raw.filter(e=>e!==t)};case"reconnect":return this.listeners.reconnect.push(t),()=>{this.listeners.reconnect=this.listeners.reconnect.filter(e=>e!==t)};default:throw Error(`Evento no soportado: ${e}`)}}emit(e,...t){this.listeners[e]?.forEach(e=>{try{e(...t)}catch(e){this.opts.log&&console.error("[Realtime] listener error",e)}})}connect(){if(this.ws&&("open"===this.status||"connecting"===this.status)){this.opts.log&&console.log("[RealtimeWS] Ya conectado/conectando, estado:",this.status);return}this.status=this.reconnectAttempts>0?"reconnecting":"connecting",this.opts.log&&console.log("[RealtimeWS] Intentando conectar a:",this.url);try{this.ws=new WebSocket(this.url)}catch(e){this.opts.log&&console.error("[RealtimeWS] Error creando WebSocket:",e),this.status="error",this.emit("error",e);return}this.ws.onopen=()=>{this.opts.log&&console.log("[RealtimeWS] Conexi\xf3n abierta"),this.status="open",this.emit("open"),this.reconnectAttempts=0,this.startHeartbeat()},this.ws.onmessage=e=>{let t;this.opts.log&&console.log("[RealtimeWS] Mensaje recibido:",e.data);try{t=JSON.parse(e.data)}catch{return}switch(this.emit("raw",t),t.type){case"session":this.sessionId=t.session_id,this.emit("session",this.sessionId);break;case"prediction":{let e=(0,a.lJ)(t);this.emit("prediction",e);break}case"pong":this.clearHeartbeatTimeout();break;case"error":this.emit("error",t.error)}},this.ws.onerror=e=>{this.opts.log&&console.error("[RealtimeWS] Error en WebSocket:",e),this.emit("error",e)},this.ws.onclose=e=>{this.opts.log&&console.log("[RealtimeWS] Conexi\xf3n cerrada:",e.code,e.reason),this.stopHeartbeat(),this.emit("close",e),"closing"!==this.status&&(this.status="error",this.opts.autoReconnect&&this.reconnectAttempts<this.opts.maxReconnectAttempts&&this.scheduleReconnect())}}scheduleReconnect(){this.reconnectAttempts+=1;let e=Math.min(this.opts.backoffInitialMs*Math.pow(this.opts.backoffFactor,this.reconnectAttempts-1),this.opts.backoffMaxMs);this.emit("reconnect",this.reconnectAttempts,e),setTimeout(()=>this.connect(),e)}startHeartbeat(){this.opts.heartbeatIntervalMs<=0||(this.stopHeartbeat(),this.heartbeatTimer=setInterval(()=>{this.ws&&"open"===this.status&&(this.sendPing(),this.setHeartbeatTimeout())},this.opts.heartbeatIntervalMs))}stopHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=null,this.clearHeartbeatTimeout()}setHeartbeatTimeout(){this.clearHeartbeatTimeout(),this.heartbeatTimeout=setTimeout(()=>{this.opts.log&&console.warn("[Realtime] Heartbeat timeout - forcing reconnect"),this.forceReconnect()},this.opts.heartbeatTimeoutMs)}clearHeartbeatTimeout(){this.heartbeatTimeout&&clearTimeout(this.heartbeatTimeout),this.heartbeatTimeout=null}forceReconnect(){if(this.ws)try{this.ws.close()}catch{}}sendFrame(e){if(!this.ws||"open"!==this.status){this.opts.log&&console.warn("[RealtimeWS] No se puede enviar frame, ws:",!!this.ws,"status:",this.status);return}let t={type:"frame",image:e,timestamp:Date.now()};this.opts.log&&console.log("[RealtimeWS] Enviando frame, tama\xf1o:",e.length,"chars"),this.ws.send(JSON.stringify(t))}sendPing(){if(!this.ws||"open"!==this.status)return;let e={type:"ping",timestamp:Date.now()};this.ws.send(JSON.stringify(e))}close(){if(this.status="closing",this.stopHeartbeat(),this.ws)try{this.ws.close()}catch{}this.ws=null,this.status="idle"}}function o(e={}){let t=(0,r.useRef)(null),[s,a]=(0,r.useState)("idle"),[i,c]=(0,r.useState)(null),[l,u]=(0,r.useState)(null),[h,d]=(0,r.useState)(null),[m,p]=(0,r.useState)(null);(0,r.useCallback)(t=>{e.log&&console.log("[RT] prediction",t),c(e=>!e||e.letter!==t.letter||Math.abs((e.confidence||0)-(t.confidence||0))>.01?t:e)},[e.log]),t.current||(t.current=new n({log:e.log}));let g=(0,r.useCallback)(()=>{t.current?.connect()},[]);return{status:s,lastPrediction:i,sessionId:l,error:h,reconnectInfo:m,connect:g,disconnect:(0,r.useCallback)(()=>{t.current?.close(),a("idle")},[]),sendFrame:(0,r.useCallback)(e=>{t.current?.sendFrame(e)},[])}}},4564:(e,t,s)=>{s.d(t,{T:()=>n});var r=s(3210),a=s(1752),i=s(1313);function n(e={}){let t=(0,r.useMemo)(()=>({debug:!1,autoConnect:!1,confidenceThreshold:i.UC.ACCEPT,frameInterval:200,cameraConstraints:{width:640,height:480,facingMode:"user"},...e}),[e]),[s,o]=(0,r.useState)(!1),[c,l]=(0,r.useState)("prompt"),[u,h]=(0,r.useState)(!1),[d,m]=(0,r.useState)(""),[p,g]=(0,r.useState)(!1),[f,b]=(0,r.useState)(""),[w,R]=(0,r.useState)(0),[C,v]=(0,r.useState)(null),S=(0,r.useRef)(null),T=(0,r.useRef)(null),E=(0,r.useRef)(null),I=(0,r.useRef)(null),[k,M]=(0,r.useState)({totalFramesSent:0,successfulPredictions:0,averageConfidence:0,sessionDuration:0,droppedFrames:0}),F=(0,r.useRef)(Date.now()),{status:y,lastPrediction:A,error:W,connect:H,disconnect:O,sendFrame:D}=(0,a.U)({autoConnect:t.autoConnect,log:t.debug}),L=(0,r.useCallback)((e,...s)=>{t.debug&&console.log(`[ADV_CAM_${e}]`,...s)},[t.debug]),N=(0,r.useCallback)(async()=>{if(!s)return m("Camera not supported in this browser"),!1;h(!0),m("");try{L("INIT","Solicitando permisos de c\xe1mara...");let e={video:{width:{ideal:t.cameraConstraints.width},height:{ideal:t.cameraConstraints.height},facingMode:t.cameraConstraints.facingMode},audio:!1},s=await navigator.mediaDevices.getUserMedia(e);return T.current=s,S.current&&(S.current.srcObject=s,S.current.autoplay=!0,S.current.playsInline=!0,S.current.muted=!0,await new Promise((e,t)=>{let s=S.current,r=()=>{s.removeEventListener("loadedmetadata",r),s.removeEventListener("error",a),e()},a=()=>{s.removeEventListener("loadedmetadata",r),s.removeEventListener("error",a),t(Error("Video load error"))};s.addEventListener("loadedmetadata",r),s.addEventListener("error",a),s.readyState>=1&&r()}),await S.current.play()),l("granted"),L("INIT","C\xe1mara inicializada correctamente"),!0}catch(t){l("denied");let e="Camera initialization failed";return t instanceof Error?L("INIT_ERROR",e="NotAllowedError"===t.name?"Camera permission denied":`Camera initialization failed: ${t.message}`,t):L("INIT_ERROR",e),m(e),!1}finally{h(!1)}},[s,t.cameraConstraints,L]),_=(0,r.useCallback)((e,s=!1)=>{if(!(s||p)){L("FRAME","No traduciendo, saltando frame");return}if(!e?.current){if(L("FRAME","Sin cameraViewRef, usando videoRef directo"),!S.current||S.current.readyState<2){M(e=>({...e,droppedFrames:e.droppedFrames+1}));return}try{E.current||(E.current=document.createElement("canvas"));let e=E.current,s=S.current;e.width=s.videoWidth||t.cameraConstraints.width||640,e.height=s.videoHeight||t.cameraConstraints.height||480;let r=e.getContext("2d");if(!r)return;r.drawImage(s,0,0,e.width,e.height);let a=e.toDataURL("image/jpeg",.8).split(",")[1];a&&(D(a),L("FRAME",`Frame enviado desde videoRef (${a.length} chars)`))}catch{L("FRAME_ERROR","Error capturando desde videoRef"),M(e=>({...e,droppedFrames:e.droppedFrames+1}))}return}try{let s=e.current?.getVideoElement?.()||S.current;if(!s||s.readyState<2){M(e=>({...e,droppedFrames:e.droppedFrames+1}));return}E.current||(E.current=document.createElement("canvas"));let r=E.current;r.width=s.videoWidth||t.cameraConstraints.width||640,r.height=s.videoHeight||t.cameraConstraints.height||480;let a=r.getContext("2d");if(!a)return;a.drawImage(s,0,0,r.width,r.height);let i=r.toDataURL("image/jpeg",.8).split(",")[1];i&&(D(i),L("FRAME",`Frame enviado desde cameraViewRef (${i.length} chars)`))}catch{L("FRAME_ERROR","Error capturando frame"),M(e=>({...e,droppedFrames:e.droppedFrames+1}))}},[p,D,t.cameraConstraints,L]),x=(0,r.useCallback)(e=>{p||(L("RT_START","Iniciando traducci\xf3n en tiempo real"),F.current=Date.now(),H(),g(!0),b(""),R(0),I.current=setInterval(()=>{_(e,!0)},t.frameInterval),L("RT_START",`Interval iniciado con ID: ${I.current}`))},[p,H,_,t.frameInterval,L]),P=(0,r.useCallback)(()=>{p&&(L("RT_STOP","Deteniendo traducci\xf3n"),g(!1),I.current&&(clearInterval(I.current),I.current=null),O())},[p,O,L]),j=(0,r.useCallback)(()=>{L("CLEANUP","Limpiando recursos"),T.current&&(T.current.getTracks().forEach(e=>e.stop()),T.current=null),S.current&&(S.current.srcObject=null),P(),l("prompt"),m(""),M({totalFramesSent:0,successfulPredictions:0,averageConfidence:0,sessionDuration:0,droppedFrames:0})},[P,L]),U=(0,r.useCallback)(()=>new Promise(e=>{if(!S.current||S.current.readyState<2){e(null);return}let t=document.createElement("canvas"),s=t.getContext("2d");if(!s){e(null);return}let r=S.current;t.width=r.videoWidth,t.height=r.videoHeight,s.drawImage(r,0,0),t.toBlob(t=>{t?e(new File([t],"frame.jpg",{type:"image/jpeg"})):e(null)},"image/jpeg",.8)}),[]);return{videoRef:S,isSupported:s,permission:c,isInitializing:u,error:d,isTranslating:p,currentPrediction:f,confidence:w,lastTranslation:C,realtimeStatus:y,initialize:N,cleanup:j,captureFrame:U,startRealtimeTranslation:x,stopRealtimeTranslation:P,getStats:(0,r.useCallback)(()=>({...k,sessionDuration:Date.now()-F.current}),[k]),updateOptions:(0,r.useCallback)(e=>{Object.assign(t,e),L("CONFIG","Opciones actualizadas:",e)},[L,t])}}}};